from scripts.utils.setup_logger import make_logger
from scripts.utils.telegram_logger import send_tg_message
import pandas as pd

logger = make_logger(__name__, use_telegram=False)


def prepare_final_ozon_data(df_info: pd.DataFrame, df_stocks: pd.DataFrame, name: str) -> pd.DataFrame:
    """
    üì¶ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è OZON: –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤.

    –§—É–Ω–∫—Ü–∏—è –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö (`df_info`) —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏ (`df_stocks`),
    –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π DataFrame –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏
    –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –ø—Ä–∏–≥–æ–¥–Ω–æ–º –¥–ª—è OZON –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    -------------
    df_info : pd.DataFrame
        –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ OZON. –î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É `sku` –∏ –¥—Ä—É–≥–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∫–∞—Ä—Ç–æ—á–µ–∫.

    df_stocks : pd.DataFrame
        –¢–∞–±–ª–∏—Ü–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ SKU. –î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª—è:
        - `sku`
        - `name`
        - `available_stock_count`
        - `valid_stock_count`

    name : str
        –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–∞ –∏–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö Telegram).

    üì§ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    --------------
    pd.DataFrame
        –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π DataFrame, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
        - –±–∞–∑–æ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∫–∞—Ä—Ç–æ—á–µ–∫ (–∞—Ä—Ç–∏–∫—É–ª, —É–ø–∞–∫–æ–≤–∫–∞, –±—Ä–µ–Ω–¥, —Ñ–æ—Ç–æ, —Ü–≤–µ—Ç –∏ —Ç.–¥.);
        - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∏ –≥–æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞;
        - —Ç–∏–ø –∫–∞—Ä—Ç–æ—á–∫–∏ (`–¢–∏–ø`);
        - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ–º—É –æ—Å—Ç–∞—Ç–∫—É –ø–æ —É–±—ã–≤–∞–Ω–∏—é.

    üìë –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
    ----------------------
    1. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ SKU –∏ –Ω–∞–∑–≤–∞–Ω–∏—é (—Å—É–º–º–∏—Ä—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è).
    2. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –ø–æ `sku`.
    3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–æ–ª–æ–Ω–æ–∫.
    4. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω.
    5. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—Å—Ç–∞—Ç–∫–æ–≤.
    6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.

    ‚ö†Ô∏è –û—à–∏–±–∫–∏:
    ----------
    - –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –≤ –ª—é–±–æ–º –±–ª–æ–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `send_tg_message`.
    - –í –ª–æ–≥–∞—Ö —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–∫–∏ –∏ –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ.

    üß† –ê–≤—Ç–æ—Ä: –ò–ª—å—è  
    üóì –í–µ—Ä—Å–∏—è: –ò—é–ª—å 2025
    """
    send_tg_message(f"üöÄ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ OZON –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–∞: {name}")
    try:
        logger.info(f"{name} - üì¶ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤...")
        columns_to_keep = [
            'sku', 'name', 'available_stock_count', 'valid_stock_count',

        ]

        df_filtered_stocks = df_stocks[columns_to_keep]

        df_filtered_stocks = df_filtered_stocks.groupby([
            'sku', 'name',
        ]).agg({
            'available_stock_count': 'sum',
            'valid_stock_count': 'sum'
        }).reset_index()

        logger.info(
            f"{name} - ‚úÖ –û—Å—Ç–∞—Ç–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã: {len(df_filtered_stocks)} –∑–∞–ø–∏—Å–µ–π")
    except Exception:
        msg = f"{name} - ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤"
        logger.exception(msg)
        send_tg_message(msg)

    try:
        logger.info(f"{name} - üîó –û–±—ä–µ–¥–∏–Ω—è—é –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤...")
        group_df = pd.merge(
            left=df_info,
            right=df_filtered_stocks,
            left_on='sku',
            right_on='sku',
            how='left',
            suffixes=('', '_stock'),
            indicator=True

        )
        logger.info(
            f"{name} - ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: \n{group_df['_merge'].value_counts().to_dict()}")

        if group_df.columns.duplicated().any():
            logger.warning(f"{name} - ‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∫–æ–ª–æ–Ω–∫–∏:",
                           group_df.columns[group_df.columns.duplicated()])

            group_df = group_df.loc[:, ~group_df.columns.duplicated()]

        logger.info(f"{name} - ‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –∫–æ–ª–æ–Ω–∫–∏")

        group_df = group_df.rename(columns={

            'name': '—Å–º–µ–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ',
            'available_stock_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü —Ç–æ–≤–∞—Ä–∞, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫ –ø—Ä–æ–¥–∞–∂–µ',
            'valid_stock_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –±–µ–∑ –±—Ä–∞–∫–∞ –∏ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏',
        })

        group_df = group_df.filter([
            '–ê—Ä—Ç–∏–∫—É–ª', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–®—Ç—Ä–∏—Ö–∫–æ–¥', '–®–∏—Ä–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º', '–í—ã—Å–æ—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º', '–î–ª–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º',
            '–°—Å—ã–ª–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ', '–ë—Ä–µ–Ω–¥ –≤ –æ–¥–µ–∂–¥–µ –∏ –æ–±—É–≤–∏', '–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–∞ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ', '–¶–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞',
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü —Ç–æ–≤–∞—Ä–∞, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫ –ø—Ä–æ–¥–∞–∂–µ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –±–µ–∑ –±—Ä–∞–∫–∞ –∏ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏',
            '—Å–º–µ–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ'
        ])

        logger.info(f"{name} - üßº –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏")

        group_df = group_df.rename(
            columns={'—Å–º–µ–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ': '–¢–∏–ø'}
        )

        group_df = group_df.sort_values(
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü —Ç–æ–≤–∞—Ä–∞, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫ –ø—Ä–æ–¥–∞–∂–µ', ascending=False)

        logger.info(f"{name} - üî¢ –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –æ—Å—Ç–∞—Ç–∫—É —Ç–æ–≤–∞—Ä–∞")

        return group_df
    except Exception:
        msg = f"{name} - ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ DataFrame"
        logger.exception(msg)
        send_tg_message(msg)
